
def configENV()
{
    try { env.COMMIT_ID = "${COMMIT_ID}"               }catch(Exception e){}
    try { env.DATE_OF_BUILD = "${DATE_OF_BUILD}"       }catch(Exception e){}
    try { env.VERSION_OF_BUILD = "${VERSION_OF_BUILD}" }catch(Exception e){}
}

def checkoutGIT()
{

    checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], gitTool: 'Default', submoduleCfg: [], userRemoteConfigs: [[credentialsId: '6e519a56-9857-46cc-ad30-369cd6984189', url: 'https://stash.slamtec.com/scm/slam/topic_slamware_release.git']]])
    //get commit id 
}

def getCommitID()
{
    sh 'git whatchanged --since="1 days ago" > gitchangelog.txt'
    sh 'head -1 gitchangelog.txt > commitid.txt'
    str1x = readFile 'commitid.txt'
    str1 = strx.split(' ')
    for(str in str1)
    {
        if (str.startsWith('commit'))
            print "this is commit"
        else
            print str
    }
    return commitid
}

def getVersion()
{
    version = readFile 'scripts/version.txt'
    return version
}

def getParamaters(commitid,date,version)
{
    // checkout the git , get the change log , 
    if ("${COMMIT_ID}" == null )
    {
        commitid = getCommitID()
    }

    if ("${DATE_OF_BUILD}" == null)
    {
        date = new Date().format('yyyyMMdd')
    }

    if ("${VERSION_OF_BUILD}" == null)
    {
        version = getVersion()
    }

}

def commit_id 
def date_build
def version_build

configENV()

stage "Get Parameters"
node('rsg' && 'i386-gcc4.6')
{
    //checkout
    // git log get the last commit id 
    checkoutGIT()
    getParamaters(commit_id,date_build,version_build)
    // get the sha of the last commit 

    echo commit_id
    echo date_build
    echo version_build
}

stage "Stage One - Build "


def branches = [:]

branches["RPSG-RELEASE-agent-daily"] = {
    build 'RPSG-RELEASE-agent-daily_new',parameters: [
    [$class: 'StringParameterValue', name: 'COMMIT_ID', value: commit_id ],
    [$class: 'StringParameterValue', name: 'DATE_OF_BUILD', value: date_build],
    [$class: 'StringParameterValue', name: 'VERSION_OF_BUILD', value: version_build]
    ]
}

branches["RPSG-RELEASE-agent_x1000-daily"] = {
    build 'RPSG-RELEASE-agent_x1000-daily_new',parameters: [
    [$class: 'StringParameterValue', name: 'COMMIT_ID', value: commit_id ],
    [$class: 'StringParameterValue', name: 'DATE_OF_BUILD', value: date_build],
    [$class: 'StringParameterValue', name: 'VERSION_OF_BUILD', value: version_build]
    ]
}

branches["RPSG-RELEASE-depthcam-daily"] = {
    build 'RPSG-RELEASE-depthcam-daily_new',parameters: [
    [$class: 'StringParameterValue', name: 'COMMIT_ID', value: commit_id ],
    [$class: 'StringParameterValue', name: 'DATE_OF_BUILD', value: date_build],
    [$class: 'StringParameterValue', name: 'VERSION_OF_BUILD', value: version_build]
    ]
}
branches["RPSG-RELEASE-firmwares-daily"] = {
    build 'RPSG-RELEASE-firmwares-daily_new',parameters: [
    [$class: 'StringParameterValue', name: 'COMMIT_ID', value: commit_id ],
    [$class: 'StringParameterValue', name: 'DATE_OF_BUILD', value: date_build],
    [$class: 'StringParameterValue', name: 'VERSION_OF_BUILD', value: version_build]
    ]
}

branches["RPSG-RELEASE-slamwared-daily"] = {
    build 'RPSG-RELEASE-slamwared-daily_new',parameters: [
    [$class: 'StringParameterValue', name: 'COMMIT_ID', value: commit_id ],
    [$class: 'StringParameterValue', name: 'DATE_OF_BUILD', value: date_build],
    [$class: 'StringParameterValue', name: 'VERSION_OF_BUILD', value: version_build]
    ]
}
/*
branches["RPSG-RELEASE-slamwared_x1000-daily"] = {
    build 'RPSG-RELEASE-slamwared_x1000-daily',parameters: [[$class: 'StringParameterValue', name: 'COMMIT_ID', value: COMMIT_ID]]
}

branches["RPSG-RELEASE-sweep_opt-slamwared_x1000-daily"] = {
    build 'RPSG-RELEASE-sweep_opt-slamwared_x1000-daily',parameters: [[$class: 'StringParameterValue', name: 'COMMIT_ID', value: COMMIT_ID]]
}



parallel branches


stage "Daily Build"

{
    build 'RPSG-RELEASE-edison-daily',parameters: [[$class: 'StringParameterValue', name: 'COMMIT_ID', value: COMMIT_ID]]
    build 'RPSG-RELEASE-x1000-daily',parameters: [[$class: 'StringParameterValue', name: 'COMMIT_ID', value: COMMIT_ID]]
    build 'RPSG-RELEASE-sweep_opt-system_x1000-daily-test',parameters: [[$class: 'StringParameterValue', name: 'COMMIT_ID', value: COMMIT_ID]]

}
*/


